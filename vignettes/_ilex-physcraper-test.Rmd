---
title: "ilex-physcraper-test"
output: rmarkdown::html_document
---

To perform a test of Physcraper functionality, we pruned the Gottlieb et al. tree down ~20%, excluding the outgroups, corresponding to approximately 9 tips. We then performed a Physcraper run to test if we would recover the dropped tips.
The input alignment will be automatically trimmed y Physcraper

We performed the following steps:

1. [Pruning the tree](#pruning)
1. [Matching the names](#matching)
1. [Running Physcraper](#running)
1. [Checking the results](#checking)
1. Analyzing Physcraper results

# Pruning the Gottlieb et al. tree

## Getting the tree from the Open Tree of Life database

```{r, echo = TRUE}
tree6577_pg_2827 <- rotl::get_study_tree(study_id = "pg_2827", tree_id = "tree6577", tip_label = "ott_taxon_name")

```

## Identifying the outgroups
```{r, echo=TRUE}
outgroup_index <- match(c("Helwingia_chinensis", "Helwingia_japonica"), tree6577_pg_2827$tip.label)
```


## Getting the ingroup tip labels
```{r, echo=TRUE}
ingroup_tip.label <- tree6577_pg_2827$tip.label[-outgroup_index]
```


## Calculating the number of tips to keep
```{r, echo=TRUE}
ingroup_ntip <- length(ingroup_tip.label)
ingroup_ntip* 0.8
```

## Choosing at random the ingroup tips to drop
```{r, echo = TRUE}

set.seed(19022021)
todrop <- sample(ingroup_tip.label, ingroup_ntip-37)
todrop
```

## Dropping the tips from the tree

```{r, echo=TRUE}
pruned_tree <- ape::drop.tip(phy = tree6577_pg_2827, tip = todrop)
pruned_tree
```

## Saving the tree as newick and nexus

```{r, echo = TRUE}
ape::write.tree(phy = pruned_tree, file = "../data-raw/ilex-test/tree6577_pg_2827_pruned.tre")
ape::write.nexus(pruned_tree, file = "../data-raw/ilex-test/tree6577_pg_2827_pruned.nex")
```

# Matching the tree tip labels

## First generate a simple text file containing one tip label per line

```{r, echo = TRUE}

write(paste(pruned_tree$tip.label, collapse = "\n"), file = "../data-raw/ilex-test/pruned_tree_tip_labels.txt")
```
# Running the test

## Locally

```
physcraper_run.py -tf physcraperex/data-raw/ilex-test/tree6577_pg_2827_pruned.tre -tfs newick -a physcraperex/data-raw/alignments/T1281-M2478.nex -as nexus -ti physcraperex/data-raw/ilex-test/pruned_tree_tip_labels_mapped/main.json -db local_blast_db -nt 8 -o physcraperex/data/ilex-test-local
```

## Remotely
```
physcraper_run.py -tf physcraperex/data-raw/ilex-test/tree6577_pg_2827_pruned.tre -tfs newick -a physcraperex/data-raw/alignments/T1281-M2478.nex -as nexus -ti physcraperex/data-raw/ilex-test/pruned_tree_tip_labels_mapped/main.json -o physcraperex/data/ilex-test-remote
```


# Checking the results of the test

## Checking that the original alignment was appropriately trimmed



